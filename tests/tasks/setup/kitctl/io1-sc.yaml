---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: create-storageclass
  namespace: tekton-pipelines
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Kubernetes
    tekton.dev/tags: CLI, kubectl
    tekton.dev/displayName: "kubernetes actions"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: |
    Setup a new storage class in the guest cluster.
  params:
  - name: cluster-name
    default: "guest"
    description: Name of the guest cluster
  steps:
  - name: setup-storageclass
    image: bitnami/kubectl
    script: |
      #!/bin/bash
      kubectl get secret -n $(params.cluster-name) $(params.cluster-name)-kube-admin-config -ojsonpath='{.data.config}' | base64 -d > /tmp/kubeconfig
      cat <<EOF | kubectl --kubeconfig=/tmp/kubeconfig apply -f -
      kind: StorageClass
      apiVersion: storage.k8s.io/v1
      metadata:
        name: io1
      provisioner: ebs.csi.aws.com
      parameters:
        type: "io1"
        iopsPerGB: "50"
      reclaimPolicy: Delete
      volumeBindingMode: WaitForFirstConsumer
      EOF
      echo "Approving KCM requests"
      kubectl --kubeconfig /tmp/kubeconfig certificate approve $(kubectl --kubeconfig /tmp/kubeconfig get csr | grep "Pending" | awk '{print $1}')  2>/dev/null  || true
