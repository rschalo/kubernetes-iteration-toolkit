# taint by label node.kubernetes.io/instance-type: t3a.xlarge
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: label-and-taint-node
  namespace: tekton-pipelines
  annotations:
    tekton.dev/pipelines.minVersion: "0.17.0"
    tekton.dev/categories: Kubernetes
    tekton.dev/tags: CLI, kubectl
    tekton.dev/displayName: "kubernetes actions"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: |
    Taint a node object.
  params:
  - name: cluster-name
    default: "guest"
    description: name of the guest cluster.
  - name: selectors
    default: ""
    description: selectors to fetch the k8s nodes. e.g. key1=value1,key2=value2
  - name: taint
    default: "monitoring=true:NoSchedule"
    description: Taint to apply to the k8s node.
  - name: labels
    default: ""
    description: labels to add to the k8s nodes. e.g. key1=value1,key2=value2
  steps:
  - name: kubectl-taint
    image: bitnami/kubectl:1.24.5
    script: |
      echo "Getting kube admin config"
      kubectl get secret -n $(params.cluster-name) $(params.cluster-name)-kube-admin-config -ojsonpath='{.data.config}' | base64 -d > /tmp/kubeconfig
      echo "finding node(s) to add taint"

      if [ ! -z $(params.taint) ]; then
        kubectl --kubeconfig=/tmp/kubeconfig taint nodes --overwrite -l $(params.selectors) $(params.taint)
      fi
      if [ ! -z $(params.labels) ]; then
        kubectl --kubeconfig=/tmp/kubeconfig label nodes --overwrite -l $(params.selectors) $(params.labels)
      fi